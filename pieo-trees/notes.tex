\documentclass{amsart}

% font
\usepackage{cmbright}

% margin 
\usepackage[margin=1in]{geometry}

% references
\usepackage[colorlinks]{hyperref} 
\PassOptionsToPackage{colorlinks}{hyperref}
\hypersetup{urlcolor = RedViolet, linkcolor = RoyalBlue, citecolor = NavyBlue}
\urlstyle{same}

\usepackage{amsmath, amssymb, amsthm} 
\usepackage[svgnames, dvipsnames]{xcolor}
\usepackage{mhsetup, mathtools}

\usepackage[capitalise]{cleveref}
\usepackage[T1]{fontenc} 
\usepackage{silence} % for suppressing warnings
\usepackage{cite}

% hats
\usepackage{yhmath}

% PL macros
\usepackage{mathpartir}
\usepackage{stmaryrd}
\newcommand{\inference}[3]{\inferrule*[Right=#1]{#2}{#3}}
\newcommand{\axiom}[2]{\inferrule*[Right=#1]{\;}{#2}}
\DeclareMathOperator{\bigstep}{\Downarrow}
\DeclareMathOperator{\false}{\textbf{false}}
\DeclareMathOperator{\true}{\mathbf{true}}
\newcommand{\hoare}[3]{\{#1\} \; #2 \; \{#3\}}

% (Formal Abstractions macros)++
\DeclareMathOperator{\halfto}{\rightharpoonup}
\DeclareMathOperator{\pkt}{\mathrm{pkt}}
\DeclareMathOperator{\push}{\mathrm{push}}
\DeclareMathOperator{\pop}{\mathrm{pop}}
\DeclareMathOperator{\Pkt}{\mathbf{Pkt}}
\DeclareMathOperator{\Rk}{\mathbf{Rk}}
\DeclareMathOperator{\Data}{\mathbf{Data}}
\DeclareMathOperator{\Topo}{\mathbf{Topo}}
\DeclareMathOperator{\Path}{\mathbf{Path}}
\DeclareMathOperator{\PIEO}{\mathbf{PIEO}}
\DeclareMathOperator{\PIFO}{\mathbf{PIFO}}
\DeclareMathOperator{\PIEOTree}{\mathbf{PIEOTree}}
\DeclareMathOperator{\PIFOTree}{\mathbf{PIFOTree}}
\DeclareMathOperator{\Leaf}{\mathrm{Leaf}}
\DeclareMathOperator{\Internal}{\mathrm{Internal}}
\DeclareMathOperator{\Node}{\mathrm{Node}}

% theorems
\newtheorem{thm}{Theorem}[section]
\newtheorem{lem}[thm]{Lemma}
\theoremstyle{definition}
\newtheorem{dfn}[thm]{Definition}
\newtheorem{abuse}[thm]{Abuse of Notation}
\newtheorem{ex}[thm]{Example}
\newtheorem{rem}[thm]{Remark}

% no more indent
\setlength{\parindent}{0pt}

% right-justified sections hack
\usepackage{titlesec}
\newcommand{\marginsecnumber}[1]{%
  \makebox[0pt][r]{#1\hspace{6pt}}%
}
\titleformat{\section}
  {\normalfont\Large\bfseries}
  {\marginsecnumber\thesection}
  {0pt}
  {}
\titleformat{\subsection}
  {\normalfont\large\bfseries}
  {\marginsecnumber\thesubsection}
  {0pt}
  {}
\titleformat{\subsubsection}
  {\normalfont\normalsize\bfseries}
  {\marginsecnumber\thesubsubsection}
  {0pt}
  {}

\begin{document}

\pagestyle{empty}

{\LARGE \textbf{PIEO Trees for Fun and Profit}}

\hrulefill\\

We assume familiarity with \cite{OG}, adopt its notational conventions, and borrow its definitions!

\section{Structure \& Semantics}

\begin{dfn}
    For sets $S$, $D$, and predicates $F$ over $D$,
    let $\PIEO(S, D, F)$ denote the set of \emph{PIEO}s that
    \begin{enumerate}
        \item hold entries in $S$, decorated with meta-data in $D$
        \item are ordered by $\Rk$
        \item support predicates in $F$
        \item admit partial functions 
        \begin{align*}
            \pop &: \PIEO(S, D, F) \times F \halfto S \times \PIEO(S, D, F) \\
            \push &: \PIEO(S, D, F) \times S \times D \times \Rk \to \PIEO(S, D, F) 
        \end{align*}
    \end{enumerate}
    For $p \in \PIEO(S, D, F)$, $s \in S$, and $f \in F$, we write 
    \begin{enumerate}
        \item $|p|$ for the number of entries in $p$
        \item $|p|_{s}$ for the number of times $s$ occurs in $p$
        \item $|p|_{s,f}$ for the number of times $s$ occurs in $p$ with associated $d \in D$ such that $f(d)$ holds
    \end{enumerate}
\end{dfn}

We fix an opaque set $\Data$ and a collection $\mathcal F$ of predicates defined on it.
These predicates come with a total order $\leq$ and the property that, $\forall d \in \Data$ and $f,f^\prime \in \mathcal F$,
$f \leq f^\prime \land f(d) \implies f^\prime(d)$.

\begin{dfn}
    The set of \emph{PIEO trees} over $t \in \Topo$, denoted $\mathbf{PIEOTree}(t)$, is defined inductively by
    \begin{align*}
        \inference{}
        {
            p \in \mathbf{PIEO}(\Pkt, \Data, \mathcal F)
        }
        {
            \Leaf(p) \in \mathbf{PIEOTree}(\ast)
        }
        &&
        \inference{}
        {
            n \in \mathbb N\\
            ts \in \mathbf{Topo}^n\\
            p \in \mathbf{PIEO}(\{1,\ldots, n\}, \mathbf{Data}, \mathcal F)\\\\
            \forall i \in [1, n]. \; qs[i] \in \mathbf{PIEOTree}(ts[i])
        }
        {
            \Internal(qs, p) \in \mathbf{PIEO}(\Node(ts))
        }
    \end{align*}
\end{dfn}

\begin{dfn}
    Define $\pop : \PIEOTree(t) \times \mathcal F \halfto \Pkt \times \PIEOTree(t)$ by
    \begin{align*}
        \inference{}
        {
            \pop(p, f) = (\pkt, p^\prime)
        }
        {
            \pop(\Leaf(p), f) = (\pkt, \Leaf(p^\prime))
        }
        &&
        \inference{}
        {
            \pop(p, f) = (i, p^\prime)\\
            \pop(qs[i], f) = (\pkt, q^\prime)
        }
        {
            \pop(\Internal(qs, p), f) = (\pkt, \Internal(qs[q^\prime/i], p^\prime))
        }
    \end{align*}
\end{dfn}

\begin{dfn}
    Define $\push : \PIEOTree(t) \times \Pkt \times \Data \times \Path(t) \to \PIEOTree(t)$ by
    \begin{align*}
        \inference{}
        {
            \push(p, \pkt, d, r) = p^\prime
        }
        {
            \push(\Leaf(p), \pkt, d, r) = \Leaf(p^\prime)
        }
        &&
        \inference{}
        {
            \push(p, i, d, r) = p^\prime\\ 
            \push(qs[i],  \pkt, d, pt) = q^\prime
        }
        {
            \push(\Internal(qs, p), \pkt, d, (i, r) :: pt) = \Internal(qs[q^\prime/i], p^\prime)
        }
    \end{align*}
\end{dfn}

\begin{dfn}
    Let $t \in \Topo$. 
    A \emph{control} over $t$ is a triple $(s, q, z)$, where $s \in \mathrm{St}$ is the \emph{current state},
    $q$ is a PIEO tree of topology $t$, and 
    $$z : \mathrm{St} \times \Pkt \to \Data \times \Path(t) \times \mathrm{St}$$
    is a function called the \emph{scheduling transaction}.
\end{dfn}

\begin{dfn}
    Define $|\cdot| : \PIEOTree(t) \to \mathbb N$ by
    \begin{align*}
        |\Leaf(p)| = |p| && |\Internal(qs, p)| = \sum_{i=1}^{|qs|} |qs[i]|
    \end{align*}

    We say that $q \in \PIEOTree(t)$ is \emph{well-formed} w.r.t $f \in \mathcal F$, denoted $\vdash_f q$, if it adheres to the following rules.
    \begin{align*}
        \axiom{}
        {\vdash_f \Leaf(p)}
        &&
        \inference{}
        {
            \forall i \in [1, |qs|] \; \vdash_f qs[i] \land |p|_{i, f} = |qs[i]|
        }
        {
            \vdash_f \Internal(qs, p)
        }
    \end{align*}

    We say $q$ is well-formed, denoted $\vdash q$, if there exists $f \in \mathcal F$ such that, for all $f^\prime \geq f$, $\vdash_{f^\prime} q$.
\end{dfn}

\section{Embedding and Simulation}

\begin{dfn}
    Let $t_1, t_2 \in \Topo$. 
    We call a relation $R \subseteq \PIEOTree(t_1) \times \PIEOTree(t_2)$ a \emph{simulation} if, 
    for all $\pkt \in \Pkt$, $f \in \mathcal F$, and $q_1 \; R \; q_2$,
    \begin{enumerate}
        \item If $\pop(q_1, f)$ is undefined, then so is $\pop(q_2, f)$
        \item If $\pop(q_1, f) = (\pkt, q_1^\prime)$, then $\pop(q_2) = (\pkt, q_2^\prime)$ such that $q_1^\prime \; R \; q_2^\prime$.
        \item For all $pt_1 \in \Path(t_1)$ and $d \in \Data$, there exists $pt_2 \in \Path(t_2)$ such that
            $$\push(q_1, \pkt, d, pt_1) \; R \; \push(q_2, \pkt, d, pt_2)$$
    \end{enumerate}
    If such a simulation exists, we say that $q_1$ is \emph{simulated} by $q_2$, and we write $q_1 \preccurlyeq q_2$.
\end{dfn}

\begin{rem}
    For all further discussion, we assume our embeddings are injective.
\end{rem}

\begin{dfn}
    For $t_1, t_2 \in \Topo$, let $f$ be an embedding from $t_1$ to $t_2$.
    We lift $f$ to a map $\overline{f}$ from $\PIEOTree(t_1)$ to $\PIEOTree(t_2)$ inductively.
    \begin{itemize}
        \item For $t_1 = \ast$, define $\overline{f}(q) = q$. This is well-defined by \cite[Lemma ~5.2]{OG}.
        \item For $t_1 = \Node(ts_1)$, $n = |ts_1|$, $q = \Internal(qs, p)$, 
            construct $\overline{f}_{\alpha}(q) \in \PIEOTree(t_2/\alpha)$ for each prefix $\alpha$ of $f(i)$ for some $i \in [1,n]$.
            Inductively, we'll build up from $f(i)$'s to $\epsilon$ and set $\overline{f}(q) = \overline{f}_\epsilon(q)$.
            \begin{itemize}
                \item Let $\alpha = f(i)$ for some $i \in [1,n]$. We'll set $\overline{f}_\alpha(q) = \overline{f_i}(qs[i])$, 
                    where $f_i$ embeds $t_1/i$ into $t_2/f(i)$ as per \cite[Lemma 5.2]{OG}.
                    This well-defined by the injectivity of $f$.
                \item Let $\alpha$ point to a transient node, say with $m$ children.
                    For $1 \leq j \leq m$ such that $\alpha \cdot j$ is not a prefix of some $f(i)$, 
                    define $\overline{f}(q)_{\alpha \cdot j}$ to be the PIEO tree with empty PIEOs on all leaves and internal nodes. 
                    With this and recursion, we know $\overline{f}(q)_{\alpha \cdot j} \in \PIEOTree(t_2/(\alpha \cdot j))$ for all $j \in [1, m]$.

                    We create a new PIEO $p_\alpha$ as follows:
                    \begin{enumerate} 
                        \item Start with $p_\alpha$ empty
                        \item For each $i$ in $p$ such that $\alpha \cdot j$ is a prefix of $f(i)$, push $j$ into $p_\alpha$ with $i$'s data and rank
                    \end{enumerate}

                    Finally, for all $j \in [1,m]$, set $qs_\alpha[j] = \overline{f}(q)_{\alpha \cdot j}$ and $\overline{f}(q)_\alpha = \Internal(qs_\alpha, p_\alpha)$.
            \end{itemize}
    \end{itemize}
\end{dfn}

\begin{thm}
    \label{thm:profit}
    Let $t_1, t_2 \in \Topo$. If $f$ embeds $t_1$ into $t_2$, then 
    $$R = \{(q, f(q)) \mid q \in \PIEOTree(t_1)\}$$ 
    is a simulation.
\end{thm}

\newpage 

\renewcommand\refname{\LARGE References}
\bibliographystyle{apalike} 
\bibliography{refs}

\end{document}
